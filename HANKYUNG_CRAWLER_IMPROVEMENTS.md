# 한경 컨센서스 크롤러 개선 계획

## 📋 PDF 참고 내용 요약

### 한경 컨센서스 사용 흐름 (PDF 기준)

1. **접속 경로**
   - 포털에서 "한경 컨센서스" 검색
   - 또는 한국경제 사이트 상단 메뉴: **마켓 → 컨센서스/리서치**

2. **리포트 유형 선택**
   - 종목 리포트 ☑ (가장 많이 사용)
   - 산업 리포트
   - 시황/전략 리포트
   - 애널리스트 코멘트

3. **종목 검색 방법**
   - **방법 A**: 종목명으로 찾기
     - 검색창에 종목명 입력 (예: 삼성전자)
     - 종목 클릭
     - 리포트 목록 표시
   - **방법 B**: 최근 전체 리포트 한꺼번에 보기
     - 필터 설정: 기간(최근 1주/1개월), 증권사(전체 또는 특정)

4. **리포트 정보 구조**
   ```
   - 증권사명 (예: NH투자증권)
   - 애널리스트 이름
   - 투자의견 (BUY / HOLD / SELL)
   - 목표주가
   - 리포트 날짜
   - [리포트 보기] / [PDF] 버튼
   ```

5. **로그인/유료 여부**
   - 기본 요약 정보: 로그인 없이 가능
   - 리포트 원문/PDF: 일부는 로그인 필요, 일부는 무료
   - 실무 팁: 한경에서 막히면 → 네이버 금융에서 원문 링크 확인

6. **네이버 금융 보완 루트**
   - 네이버 → 금융 → [리서치] 메뉴
   - 종목 분석 / 산업 분석 / 시황 분석
   - 동일한 애널리스트 리포트 무료 PDF 제공되는 경우 많음

## ✅ 현재 크롤러 상태

### 구현된 기능
- ✅ `crawl_recent_reports()`: 최근 리포트 수집
- ✅ `search_by_stock()`: 종목별 검색
- ✅ 리포트 유형 필터링 (stock, industry, market, analyst)
- ✅ 증권사 필터링
- ✅ 리포트 메타데이터 추출 (제목, 애널리스트, 의견, 목표가 등)

### 개선 필요 사항

#### 1. 접속 경로 명확화
- 현재: `https://markets.hankyung.com/consensus` 직접 접속
- 개선: 한국경제 메인 페이지 → 마켓 → 컨센서스 경로 시뮬레이션 (필요시)

#### 2. 종목 리포트 탭 선택 로직 강화
- 현재: `report_type="stock"` 파라미터로 처리
- 개선: 명시적으로 "종목 리포트" 탭 클릭 시뮬레이션 또는 URL 파라미터 확인

#### 3. 리포트 목록 파싱 개선
- 현재: `_extract_report_links()` 메서드로 링크 추출
- 개선 필요:
  - 증권사명 추출 정확도 향상
  - 애널리스트 이름 추출 정확도 향상
  - 투자의견 (BUY/HOLD/SELL) 정규화
  - 목표주가 숫자 추출 개선
  - 리포트 날짜 파싱 강화

#### 4. PDF 다운로드 링크 추출
- 현재: 리포트 상세 페이지에서 PDF URL 추출 시도
- 개선:
  - [PDF] 버튼 링크 직접 추출
  - 리포트 상세 페이지에서 PDF 다운로드 링크 확인
  - 로그인 필요 여부 감지

#### 5. 네이버 금융 보완 루트 연동
- 현재: 별도 크롤러 (`crawler_naver_finance_research.py`) 존재
- 개선:
  - 한경에서 PDF 접근 실패 시 자동으로 네이버 금융에서 재시도
  - `IntegratedResearchCrawler`에서 이미 구현되어 있음 (확인 필요)

#### 6. 필터링 옵션 강화
- 현재: `firm_filter` (증권사 필터) 지원
- 개선:
  - 기간 필터 UI 시뮬레이션 (최근 1주/1개월)
  - 증권사 드롭다운 필터 지원
  - 투자의견 필터 (BUY만, HOLD만 등)

#### 7. 로그인 처리 (선택)
- 현재: 로그인 없이 접근 가능한 부분만 수집
- 개선 (선택):
  - 로그인 세션 유지 (쿠키 관리)
  - 회원 전용 리포트 접근 (환경 변수로 설정)

## 🔧 구체적 개선 작업

### 우선순위 1: 리포트 목록 파싱 개선

```python
def _extract_report_links(self, html: str, report_type: str = "stock") -> List[Dict]:
    """
    리포트 목록에서 링크 및 메타데이터 추출
    
    개선 사항:
    1. 테이블 구조 파싱 강화 (증권사, 애널리스트, 의견, 목표가 컬럼)
    2. 정규식으로 숫자 추출 (목표주가)
    3. 의견 텍스트 정규화 (BUY/HOLD/SELL)
    """
    # 현재 구현 확인 후 개선
```

### 우선순위 2: PDF 다운로드 링크 추출 개선

```python
def _extract_pdf_url(self, detail_html: str) -> Optional[str]:
    """
    리포트 상세 페이지에서 PDF URL 추출
    
    개선 사항:
    1. [PDF] 버튼 링크 직접 추출
    2. iframe 내 PDF 링크 확인
    3. 로그인 필요 여부 감지 (리다이렉트 URL 확인)
    """
```

### 우선순위 3: 네이버 금융 자동 보완

```python
def search_by_stock_with_fallback(
    self,
    stock_name: str,
    days: int = 7,
    max_reports: int = 50
) -> List[ReportMetadata]:
    """
    한경 컨센서스에서 수집 → PDF 접근 실패 시 네이버 금융으로 보완
    
    개선 사항:
    1. 한경에서 리포트 메타데이터 수집
    2. PDF 다운로드 시도
    3. 실패 시 네이버 금융에서 동일 리포트 검색
    4. 네이버에서 PDF 다운로드
    """
```

## 📊 현재 vs 개선 후 비교

| 기능 | 현재 | 개선 후 |
|------|------|---------|
| 종목 검색 | ✅ 기본 지원 | ✅ 강화된 파싱 |
| 리포트 목록 추출 | ✅ 링크 추출 | ✅ 메타데이터 완전 추출 |
| PDF 다운로드 | ⚠️ 부분 지원 | ✅ 강화된 링크 추출 |
| 네이버 보완 | ✅ 별도 크롤러 | ✅ 자동 연동 |
| 필터링 | ✅ 기본 필터 | ✅ 고급 필터 옵션 |
| 로그인 처리 | ❌ 미지원 | ⚠️ 선택적 지원 |

## 🎯 다음 단계

1. **즉시 적용 가능**
   - 리포트 목록 파싱 개선 (테이블 구조 분석)
   - PDF 링크 추출 강화
   - 의견 텍스트 정규화 개선

2. **단기 개선**
   - 네이버 금융 자동 보완 로직
   - 필터링 옵션 강화
   - 에러 처리 개선

3. **장기 개선 (선택)**
   - 로그인 세션 관리
   - 회원 전용 리포트 접근
   - 실시간 모니터링 (새 리포트 알림)

## 📝 참고 문서

- `crawler_hankyung_consensus.py`: 현재 구현
- `crawler_naver_finance_research.py`: 네이버 금융 크롤러
- `integrated_research_crawler.py`: 통합 크롤러
- `korea_normalize.py`: 정규화 시스템

